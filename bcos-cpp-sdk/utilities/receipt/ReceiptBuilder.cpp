/**
 *  Copyright (C) 2022 FISCO BCOS.
 *  SPDX-License-Identifier: Apache-2.0
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 * @file ReceiptBuilder.cpp
 * @author: kyonGuo
 * @date 2022/12/7
 */

#include "ReceiptBuilder.h"
bcostars::ReceiptDataUniquePtr bcos::cppsdk::utilities::ReceiptBuilder::createReceiptData(
    const std::string& _gasUsed, const std::string& _contractAddress, const bcos::bytes& _output,
    int64_t _blockNumber)
{
    auto _receipt = std::make_unique<bcostars::TransactionReceiptData>();
    _receipt->version = 0;
    _receipt->gasUsed = _gasUsed;
    _receipt->contractAddress = _contractAddress;
    _receipt->status = 0;
    _receipt->output.insert(_receipt->output.cbegin(), _output.begin(), _output.end());
    _receipt->logEntries.clear();
    _receipt->blockNumber = _blockNumber;
    return _receipt;
}

bcostars::ReceiptDataUniquePtr bcos::cppsdk::utilities::ReceiptBuilder::createReceiptDataWithJson(
    const std::string& _json)
{
    auto _receipt = std::make_unique<bcostars::TransactionReceiptData>();
    _receipt->readFromJsonString(_json);
    return _receipt;
}

bcos::crypto::HashType bcos::cppsdk::utilities::ReceiptBuilder::calculateReceiptDataHash(
    bcos::cppsdk::utilities::CryptoType _cryptoType,
    const bcostars::TransactionReceiptData& _receiptData)
{
    bcos::crypto::CryptoSuite* cryptoSuite = nullptr;
    if (_cryptoType == bcos::crypto::KeyPairType::SM2)
    {
        cryptoSuite = &*m_smCryptoSuite;
    }
    else if (_cryptoType == bcos::crypto::KeyPairType::HsmSM2)
    {
        return _receiptData.hash(std::make_shared<bcos::crypto::SM3>());
    }
    else
    {
        cryptoSuite = &*m_ecdsaCryptoSuite;
    }
    return _receiptData.hash(cryptoSuite->hashImpl());
}

bcos::bytesConstPtr bcos::cppsdk::utilities::ReceiptBuilder::encodeReceipt(
    const bcostars::TransactionReceiptData& _receipt)
{
    tars::TarsOutputStream<tars::BufferWriter> output;
    _receipt.writeTo(output);

    auto buffer = std::make_shared<bcos::bytes>();
    buffer->assign(output.getBuffer(), output.getBuffer() + output.getLength());
    return buffer;
}
std::string bcos::cppsdk::utilities::ReceiptBuilder::decodeReceiptDataToJsonObj(
    const bcos::bytes& _receiptBytes)
{
    tars::TarsInputStream<tars::BufferReader> inputStream;
    inputStream.setBuffer((const char*)_receiptBytes.data(), _receiptBytes.size());
    auto receiptData = std::make_unique<bcostars::TransactionReceiptData>();
    receiptData->readFrom(inputStream);
    auto receiptDataJson = receiptData->writeToJsonString();
    return receiptDataJson;
}
